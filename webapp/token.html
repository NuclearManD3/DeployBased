
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Token Detail - Deploy: Based</title>
	<link rel="stylesheet" href="style.css">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
	<header>
		<div class="logo">
			<img src="logo_wide.png" alt="Deploy: Based Logo" id="logo-wide">
			<img src="logo.png" alt="Deploy: Based Logo" id="logo-small" class="hidden">
		</div>
		<nav>
			<ul>
				<li><a href="index.html">Home</a></li>
				<li><a href="about.html">About</a></li>
				<li><a href="deploy.html">Deploy Token</a></li>
				<li><a href="mytokens.html">My Tokens</a></li>
				<li><a href="#docs">Docs</a></li>
			</ul>
		</nav>
		<div class="wallet-section">
			<select id="network-switch">
				<option value="mainnet">Mainnet</option>
				<option value="testnet">Testnet</option>
			</select>
			<button id="connect-wallet">Connect Wallet</button>
			<div id="wallet-info" class="hidden">
				<span id="usdc-balance"></span>
				<button id="disconnect-wallet">Disconnect</button>
			</div>
		</div>
	</header>
	<main>
		<h1 id="token-name">Token Name</h1>
		<p id="token-details">Details here...</p>

		<hr>

		<section id="swap-section" class="swap-section">
            <h2>Swap Tokens</h2>
            <div class="swap-row">
                <div class="swap-input">
                    <input type="number" id="swap-amount-in" placeholder="Amount" min="0">
                    <select id="swap-token-in">
                        <option value="" disabled>Select token</option>
                        <option value="" id="page-token-in">Token</option>
                    </select>
                </div>
                <button id="swap-direction" title="Switch tokens">â‡…</button>
                <div class="swap-input">
                    <input type="number" id="swap-amount-out" placeholder="Estimated" min="0" disabled>
                    <select id="swap-token-out">
                        <option value="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913" selected>USDC</option>
                    </select>
                </div>
            </div>
            <button id="swap-button">Swap</button>
            <div id="swap-status"></div>
        </section>
	</main>

	<div id="loading-spinner" class="hidden">Loading...</div>

	<script src="https://cdn.jsdelivr.net/npm/ethers@5/dist/ethers.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
	<script src="contracts.js"></script>
	<script src="swaps.js"></script>
	<script src="app.js"></script>

<style>
.swap-section {
	background-color: #1e1e1e;
	color: #eee;
	padding: 1rem;
	border-radius: 12px;
	margin-top: 2rem;
}
.swap-section h2 {
	margin-bottom: 1rem;
	font-weight: 600;
}
.swap-row {
	display: flex;
	align-items: center;
	gap: 0.5rem;
}
.swap-input {
	display: flex;
	flex-direction: column;
	flex: 1;
}
.swap-input input,
.swap-input select {
	padding: 0.5rem;
	border-radius: 6px;
	border: 1px solid #555;
	background: #2b2b2b;
	color: #eee;
	font-size: 1rem;
}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
	-webkit-appearance: none;
	margin: 0;
}
input[type=number] {
	-moz-appearance: textfield;
	appearance: none;
}
#swap-direction {
	background: none;
	color: #eee;
	font-size: 1.5rem;
	border: none;
	cursor: pointer;
}
#swap-button {
	width: 100%;
	padding: 0.75rem;
	border-radius: 8px;
	border: none;
	background-color: #4a90e2;
	color: #fff;
	font-weight: 600;
	margin-top: 1rem;
	cursor: pointer;
}
#swap-button:disabled {
	background-color: #888;
	cursor: not-allowed;
}
</style>
<script>
(async () => {
	const swapAmountIn = document.getElementById('swap-amount-in');
	const swapAmountOut = document.getElementById('swap-amount-out');
	const swapTokenIn = document.getElementById('swap-token-in');
	const swapTokenOut = document.getElementById('swap-token-out');
	const swapButton = document.getElementById('swap-button');
	const swapStatus = document.getElementById('swap-status');
	const swapDirectionBtn = document.getElementById('swap-direction');

	const tokenPageAddress = new URLSearchParams(window.location.search).get('address');
	const defaultTokens = [
		{ address: tokenPageAddress, label: 'Your Token' },
		{ address: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913', label: 'USDC' }
	];

	// Helper: populate a select with token options
	function populateDropdown(selectEl, tokens, selectedAddr) {
		selectEl.innerHTML = '';
		tokens.forEach(t => {
			const opt = document.createElement('option');
			opt.value = t.address;
			opt.text = t.label;
			if (t.address.toLowerCase() === selectedAddr?.toLowerCase()) {
				opt.selected = true;
			}
			selectEl.appendChild(opt);
		});
	}

	// Initialize both dropdowns with all tokens
	populateDropdown(swapTokenIn, defaultTokens, tokenPageAddress);
	populateDropdown(swapTokenOut, defaultTokens, defaultTokens[1].address);

	// Allow pasting arbitrary addresses
	function addTokenIfMissing(selectEl, addr) {
		addr = addr.trim();
		if (!addr) return;
		if (![...selectEl.options].some(o => o.value.toLowerCase() === addr.toLowerCase())) {
			const opt = document.createElement('option');
			opt.value = addr;
			opt.text = addr.slice(0,6) + '...' + addr.slice(-4);
			selectEl.appendChild(opt);
		}
	}

	swapTokenIn.addEventListener('change', () => addTokenIfMissing(swapTokenIn, swapTokenIn.value));
	swapTokenOut.addEventListener('change', () => addTokenIfMissing(swapTokenOut, swapTokenOut.value));

	// Debounced output estimation
	let debounceTimer;
	function debouncedEstimate() {
		clearTimeout(debounceTimer);
		debounceTimer = setTimeout(estimateOut, 500);
	}

	async function estimateOut() {
		const inAddr = swapTokenIn.value;
		const outAddr = swapTokenOut.value;
		const amountIn = parseFloat(swapAmountIn.value);
		if (!inAddr || !outAddr || isNaN(amountIn) || amountIn <= 0) {
			swapAmountOut.value = '';
			return;
		}

		try {
			const amountInRaw = ethers.utils.parseUnits(amountIn.toString(), inAddr === tokenPageAddress ? 18 : 6);
			const { poolAddress, zeroForOne, tokensIn, tokensOut } = await estimateSwap(signer, inAddr, outAddr, amountInRaw);
			const decimalsOut = outAddr === tokenPageAddress ? 18 : 6;
			swapAmountOut.value = ethers.utils.formatUnits(tokensOut, decimalsOut);
		} catch (err) {
			swapAmountOut.value = '';
			console.error(err);
		}
	}

	// Swap direction: switch selections and values, **keep options**
	swapDirectionBtn.addEventListener('click', () => {
		// Swap values
		const tempAmount = swapAmountIn.value;
		swapAmountIn.value = swapAmountOut.value;
		swapAmountOut.value = tempAmount;

		// Swap selected addresses
		const tempAddr = swapTokenIn.value;
		swapTokenIn.value = swapTokenOut.value;
		swapTokenOut.value = tempAddr;

		// Swap labels in dropdown if user added custom tokens
		const tempOptions = [...swapTokenIn.options].map(o => ({ value: o.value, text: o.text }));
		populateDropdown(swapTokenIn, [...swapTokenOut.options].map(o => ({ address: o.value, label: o.text })), swapTokenIn.value);
		populateDropdown(swapTokenOut, tempOptions.map(o => ({ address: o.value, label: o.text })), swapTokenOut.value);

		debouncedEstimate();
	});

	// Event listeners
	swapAmountIn.addEventListener('input', debouncedEstimate);
	swapTokenIn.addEventListener('change', debouncedEstimate);
	swapTokenOut.addEventListener('change', debouncedEstimate);

	swapButton.addEventListener('click', async () => {
		const inAddr = swapTokenIn.value;
		const outAddr = swapTokenOut.value;
		const amountIn = parseFloat(swapAmountIn.value);
		const amountOut = parseFloat(swapAmountOut.value);
		if (!signer || !inAddr || !outAddr || isNaN(amountIn) || amountIn <= 0) {
			alert('Fill in valid amount and connect wallet.');
			return;
		}

		swapButton.disabled = true;
		swapStatus.innerText = 'Swapping...';
		try {
			const amountInRaw = ethers.utils.parseUnits(amountIn.toString(), inAddr === tokenPageAddress ? 18 : 6);
			const amountOutMin = ethers.utils.parseUnits(amountIn.toString(), inAddr === tokenPageAddress ? 18 : 6);
			const tx = await executeSwap(signer, inAddr, outAddr, amountInRaw, amountOutMin, true);
			await tx.wait();
			swapStatus.innerText = 'Swap successful!';
			swapAmountIn.value = '';
			swapAmountOut.value = '';
		} catch (err) {
			swapStatus.innerText = 'Swap failed: ' + err.message;
			console.error(err);
		} finally {
			swapButton.disabled = false;
		}
	});
})();
</script>
</body>
</html>
